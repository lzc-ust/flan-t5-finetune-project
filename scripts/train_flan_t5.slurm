#!/bin/bash
#SBATCH --job-name=finetune-flan-t5
#SBATCH --output=logs/train_flan_t5_%j.out
#SBATCH --error=logs/train_flan_t5_%j.err
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus=4
#SBATCH --cpus-per-task=16
#SBATCH --partition=normal
#SBATCH --time=48:00:00

echo "ğŸ”µ Starting job on $(hostname) at $(date)"

# ä¿è¯åŠ è½½æ­£ç¡®bashrc
source ~/.bashrc

# æ£€æŸ¥condaæ˜¯å¦å¯ç”¨
if ! command -v conda &> /dev/null
then
    echo "âŒ conda not found. Please install Miniconda or Anaconda first."
    exit 1
fi

# æ£€æŸ¥ç¯å¢ƒæ˜¯å¦å­˜åœ¨
ENV_NAME="flan-t5-finetune"
if conda info --envs | grep -q "$ENV_NAME"; then
    echo "âœ… Conda environment '$ENV_NAME' found. Activating..."
else
    echo "âš ï¸ Conda environment '$ENV_NAME' not found. Initializing environment setup..."
    bash init_env.sh
fi

# æ¿€æ´»ç¯å¢ƒ
conda activate $ENV_NAME

# æ˜¾ç¤ºCUDAä¿¡æ¯
nvidia-smi

# åŠ è½½Accelerateé…ç½®ï¼ˆå¦‚æœå·²ç»æœ‰ï¼‰
if [ ! -f ~/.cache/huggingface/accelerate/default_config.yaml ]; then
    echo "âš ï¸ Accelerate config not found. Please run 'accelerate config' manually before first training."
else
    echo "âœ… Found Accelerate config."
fi

# æ­£å¼å¯åŠ¨è®­ç»ƒ
echo "ğŸš€ Launching training..."
accelerate launch --multi_gpu --mixed_precision fp16 src/train_flan_t5.py
echo "âœ… Training completed on $(hostname) at $(date)"